#!/bin/bash
# this assumes this template is being called by the tse_awsnodes::linuxnode defined type
# the $nodename = $title
PE_MASTER='<%= @pe_master_hostname %>'
AWS_INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)

# prepend nodename to instance id if it exists
<% if @nodename %>
PE_CERTNAME="<%= @nodename %>-${AWS_INSTANCE_ID}"
<% else %>
PE_CERTNAME="${AWS_INSTANCE_ID}"
<% end %>


# these are attributes we know already
PP_INSTANCE_ID="${AWS_INSTANCE_ID}"

<% if @pp_image_id %>
PP_IMAGE_NAME='<%= @pp_image_id %>'
<% else %>
PP_IMAGE_NAME=$(curl -s http://169.254.169.254/latest/meta-data/ami-id)
<% end %>

if [ ! -z "${PREPEND


# these are all the OIDs that we may map or already have
# see PUP-3986 and
# https://docs.puppetlabs.com/puppet/latest/reference/ssl_attributes_extensions.html

function write_csr_attributes () {
  if [ ! -d /etc/puppetlabs/puppet ]; then
    mkdir -p /etc/puppetlabs/puppet
  fi
  # Until PUP-3986 is shipping live, these
  # are the attribute names.
  # we can leave these as OID's here and
  # they will resolve in the future as OID
  # or as name in the future 
  # 1.3.6.1.4.1.34380.1.1.15 = pp_department
  # 1.3.6.1.4.1.34380.1.1.11 = pp_created_by
  # 1.3.6.1.4.1.34380.1.1.7 = pp_project

  cat > /etc/puppetlabs/puppet/csr_attributes.yaml << YAML
extension_requests:
  pp_instance_id: $PP_INSTANCE_ID
  pp_image_name: $PP_IMAGE_NAME
YAML
  
<% if @pp_uuid %>
  echo '  pp_uuid: <%= @pp_uuid %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_preshared_key %>
  echo '  pp_preshared_key: <%= @pp_preshared_key %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_cost_center %>
  echo '  1.3.6.1.4.1.34380.1.1.5: <%= @pp_cost_center %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_product %>
  echo '  1.3.6.1.4.1.34380.1.1.6: <%= @pp_product %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_project %>
  echo '  1.3.6.1.4.1.34380.1.1.7: <%= @pp_project %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_application %>
  echo '  1.3.6.1.4.1.34380.1.1.8: <%= @pp_application %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_service %>
  echo '  1.3.6.1.4.1.34380.1.1.9: <%= @pp_service %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_employee %>
  echo '  1.3.6.1.4.1.34380.1.1.10: <%= @pp_employee %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_created_by %>
  echo '  1.3.6.1.4.1.34380.1.1.11: <%= @pp_created_by %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_environment %>
  echo '  1.3.6.1.4.1.34380.1.1.12: <%= @pp_environment %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_role %>
  echo '  1.3.6.1.4.1.34380.1.1.13: <%= @pp_role %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_software_version %>
  echo '  1.3.6.1.4.1.34380.1.1.14: <%= @pp_software_version %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_department %>
  echo '  1.3.6.1.4.1.34380.1.1.15: <%= @pp_department %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_cluster %>
  echo '  1.3.6.1.4.1.34380.1.1.16: <%= @pp_cluster %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>
<% if @pp_provisioner %>
  echo '  1.3.6.1.4.1.34380.1.1.17: <%= @pp_provisioner %>' >> /etc/puppetlabs/puppet/csr_attributes.yaml
<% end %>

}

function install_pe_agent () {
  curl -sk https://$PE_MASTER:8140/packages/current/install.bash | /bin/bash -s agent:certname=$PE_CERTNAME
}

write_csr_attributes
install_pe_agent
